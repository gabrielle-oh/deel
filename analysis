/* Count of statuses */
SELECT state, COUNT(state)
FROM acceptance
GROUP BY state; -- Declined: 1653, accepted: 3777

/* Analysis of aggregates based on status */
SELECT state, MIN(amount), MAX(amount), AVG(amount)
FROM acceptance
GROUP BY state;

/* Looking at declines over time in recent period */
SELECT DATE_TRUNC('month', date_time) AS month, COUNT(state)
FROM acceptance
WHERE state = "DECLINED"
GROUP BY month
ORDER BY month;

/* Checking for correlation between cvv_provided and declines */
SELECT state, count(cvv_provided)
FROM acceptance as a
WHERE cvv_provided = "TRUE"
GROUP BY state;

/* Checking for correlation between chargebacks and declines */
SELECT state, count(chargeback)
FROM acceptance as a
LEFT JOIN chargeback as c
USING (external_ref)
WHERE chargeback = "TRUE"
GROUP BY state;

/* Convert state column to simplify queries */
UPDATE acceptance
	SET state = 0
	WHERE state = "ACCEPTED";

UPDATE acceptance
	SET state = 1
	WHERE state = "DECLINED";

/* Checking for correlation between declines and country */
SELECT country,
        SUM(state) AS declines,
        COUNT(external_ref) AS total_tran
FROM acceptance
GROUP BY country; -- no significant distribution

/* Checking for correlation between declines and currency */
SELECT currency,
        SUM(state) AS declines,
        COUNT(external_ref) AS total_tran
FROM acceptance
GROUP BY currency; -- USD has slightly higher ratio of declines but not statistically significant

/* Checking for correlation between week and declines */
SELECT DATE_TRUNC('week', date_time) AS week,
        SUM(state) AS declines,
        COUNT(external_ref) AS total_tran
FROM acceptance
GROUP BY week
ORDER BY declines DESC;
